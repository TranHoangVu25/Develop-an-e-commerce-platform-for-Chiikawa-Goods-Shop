version: '3.9'

services:
  # üêá RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  # üçÉ MongoDB cho Product Service
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: 123456
      MONGO_INITDB_DATABASE: product_service
    volumes:
      - mongo_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro

  # üîç Elasticsearch
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck: # TƒÇNG TH·ªúI GIAN KH·ªûI ƒê·ªòNG V√Ä S·ªê L·∫¶N TH·ª¨
      test: [ "CMD", "curl", "-f", "http://localhost:9200" ]
      interval: 10s
      timeout: 5s
      retries: 20       # TƒÉng s·ªë l·∫ßn th·ª≠ l√™n 20 (t·ªïng c·ªông 200s)
      start_period: 120s # TƒÉng th·ªùi gian kh·ªüi ƒë·ªông ban ƒë·∫ßu l√™n 60s

  # üìä Kibana (t√πy ch·ªçn)
  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch


  # üü© Product Service (Java Spring Boot)
  product_service:
    build:
      context: ./chikawa_product_service
      dockerfile: Dockerfile
    container_name: product_service
    ports:
      - "8082:8082"
    depends_on:
      - mongodb
      - rabbitmq
    environment:
      # C·∫•u h√¨nh MongoDB
      SPRING_DATA_MONGODB_URI: mongodb://admin:123456@mongodb:27017/product_service?authSource=admin
      SPRING_DATA_MONGODB_AUTO_INDEX_CREATION: "true" # ƒê·∫£m b·∫£o gi√° tr·ªã boolean ƒë∆∞·ª£c truy·ªÅn d∆∞·ªõi d·∫°ng string n·∫øu c·∫ßn

      # C·∫•u h√¨nh RabbitMQ
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest

      # C·∫•u h√¨nh Server
      SERVER_PORT: 8082 # Port n·ªôi b·ªô

      # C·∫•u h√¨nh JWT
      JWT_SIGNER_KEY: "3m47O+gM3Sc0lc9I5pMhfGFZMoqvbFtLoNs6Lmq9nOg="


  # üü¶ Search Service (Java Spring Boot)
  search_service:
    build:
      context: ./search_service
      dockerfile: Dockerfile
    container_name: search_service
    ports:
      - "8084:8084"
    depends_on:
      elasticsearch: # <--- B·ªè d·∫•u g·∫°ch ngang (-) v√† b·∫Øt ƒë·∫ßu b·∫±ng t√™n service
        condition: service_healthy
      rabbitmq:
        condition: service_started # RabbitMQ kh√¥ng c√≥ healthcheck, d√πng service_started
    environment:
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      SPRING_RABBITMQ_HOST: rabbitmq


  # üõí Cart Service (Java Spring Boot)
  chikawa_cart_service:
    build:
      context: ./chikawa_cart_service
      dockerfile: Dockerfile
    container_name: chikawa_cart_service
    ports:
      - "8079:8079" # √Ånh x·∫° port 8079
    depends_on:
      - mongodb
      - rabbitmq
      - product_service # Ph·ª• thu·ªôc v√†o Product Service ƒë·ªÉ g·ªçi API
    environment:
      # MongoDB URI: Thay localhost b·∫±ng t√™n service 'mongodb' v√† DB l√† 'cart_service'
      SPRING_DATA_MONGODB_URI: mongodb://admin:123456@mongodb:27017/cart_service?authSource=admin

      # RabbitMQ Host: Thay localhost b·∫±ng t√™n service 'rabbitmq'
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest

volumes:
  mongo_data:
  es_data:
